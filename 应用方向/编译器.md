# 探索Rust编译器：GCC与LLVM

## 什么是LLVM？

LLVM是由可重用的编译器和工具链组件组成的编译器基础架构集合。LLVM在技术上是底层虚拟机的缩写，但随着时间的推移，这个缩写本身已经成为项目的品牌。LLVM以其优化代码和跨各种编程语言生成高性能机器代码的能力而闻名。

标准编译器基础结构可以分为前端、中端和后端。前端将作为高级编程语言之间的转换层，这在不同的编译器(包括LLVM和GCC)之间是相似的。

中端对代码应用各种优化，例如循环展开和函数内联。LLVM IR是LLVM的中间表示，可以根据目标架构直接优化编译多个不同的后端。

从一开始，LLVM就一直是Rust编译器的默认后端，rustc本质上是一个LLVM前端。事实证明，Rust和LLVM之间的合作是成功的，因为LLVM的先进优化技术提高了Rust程序的性能，并允许它们在多个平台上运行。

## 什么是GCC？

GCC代表GNU编译器集合，是一个开源编译器集合，支持各种编程语言，如C、C++、Fortran等。它以其稳定性、可靠性以及对不同体系结构和操作系统的广泛支持而闻名。

除了上面列出的语言之外，GCC已经发展到支持许多其他语言，包括Ada、Java、Go，以及最近(仍在开发中)的Rust。

有多个前端支持各种语言，每个前端都将编程语言转换为抽象语法树(AST)。AST是前端和中端之间的中介。

LLVM有IR作为它的中介表示，而GCC有GIMPLE和RTL。GIMPLE是由GCC中间端处理的高级中介表示。GIMPLE提供了程序的简化表示，保留了高级语义并简化了优化任务。

然后，在GIMPLE表示之后，将代码进一步转换为RTL。这种底层表示非常类似于汇编语言指令，在用于生成机器代码之前进行了进一步的优化。

目前正在为Rust开发一个名为gccrs的GCC前端。该项目还不稳定，尚未正式集成到GCC中。

## GCC与LLVM：架构上的差异

作为一个编译器集合，与LLVM相比，GCC有不同的编译方法。GCC采用更传统的方法，使用前端来解析源代码并生成AST。

然后将此AST转换为称为GIMPLE的高级中介表示，GIMPLE保留程序的高级语义。与LLVM不同，GCC增加了一个中间表示：RTL。

![](../learning/src/objInfo/assets/Pasted%20image%2020240220175054.png)
这两种优化的目标是不同的。GIMPLE侧重于高级优化，而RTL侧重于底层优化和转换为类似汇编的指令。

LLVM直接从前端到它的中间表示LLVM IR，LLVM IR优化与语言无关，与体系结构无关。这允许LLVM执行各种优化，这可以使不同的编程语言和目标体系结构受益：
![](../learning/src/objInfo/assets/Pasted%20image%2020240220175109.png)
然而，GCC和LLVM之间最惊人的区别在于它们如何构建源代码。LLVM是模块化的，从一开始，它就被构建为可扩展的，并被多种语言使用，目标是广泛的后端机器。

另一方面，GCC被设计为具有紧耦合组件的单片编译器。可以为GCC创建扩展，但它的大多数代码都是紧密结合的，需要下载整个GCC代码库才能进行更改或添加。

## 安装gccrs

Rust编程语言主要使用LLVM作为默认的编译器基础结构。如上所述，rustc是使用LLVM的前端，这意味着Rust代码默认使用LLVM的优化和转换来生成机器码。

要在Rust中使用GCC，需要使用gccrs。gccrs是Rust编译器的另一个前端，它使用本地GCC作为后端。

要安装和使用gccrs，请参考https://github.com/Rust-GCC/gccrs，根据不同的操作系统进行安装。

gccrs仍处于早期开发阶段，因此它不能支持大多数Rust语法，特别是与带有LLVM的Rust相比。例如，目前gccrs不支持Rust宏，因此很难在GCC和LLVM之间仔细比较Rust。

## 未来前景：正在进行的项目和开发

用GCC和LLVM编译Rust代码在性能和优化方面可能会产生不同的结果，这两种方法都有其独特的优势。以GCC为例，它可以针对各种体系结构进行编译，并且已经存在了很长时间，使其在某些领域更加成熟和稳定。它有一个经过几十年优化的成熟代码库。

有两个项目正在努力使Rust与gcc兼容。当然，第一个是gccrs，第二个是rustc_codegen_gcc。

两者之间的区别在于，rustc_codegen_gcc使用rustc前端为GCC后端生成中间表示。与gccrs相比，它更稳定，可以为使用GCC后端的Rust代码提供更好的编译体验。

## 为什么gccrs对Rust社区很重要

首先，它还处于社区主导的早期阶段，rustc仍然是主要的Rust编译器。但是有一个社区主导的编译器为Rust生态系统增加了更多的多样性，帮助Rust在多个生态系统中更加通用。

拥有gccr也有助于促进更多的社区创新，Rust在大多数目标平台上已经是一种高性能语言，但是在一些小众平台中，使用GCC的体系结构进行优化可能会更有效。

GCC比较老，相对稳定，它针对的是与LLVM不兼容的遗留系统——例如，摩托罗拉68000 (m68k)，一种在20世纪80年代和90年代普遍使用的遗留微处理器。通过GCC可以很容易地访问许多这样的遗留微处理器。考虑到技术的过时程度，让LLVM支持它们是不合理的。

## 总结

今天，我们探索了Rust编译的发展前景，重点关注两个项目：LLVM和GCC。这两个项目在Rust编译方法上都有独特的优点、设计理念和目标。但是，应该注意到gccrs项目仍处于开发的早期阶段，并不能完全支持Rust语言的所有特性。


