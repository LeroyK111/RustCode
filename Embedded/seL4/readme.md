当前嵌入式虚拟机管理器大多采用的L4微内核架构[2]。seL4是在L4基础上开发的高安全的嵌入式微内核操作系统版本，不仅仅对L4微内核架构进行了优化，而且是第一个通过完整的形式化验证以及可以对最坏执行情况进行分析的微内核架构。因此本文在seL4微内核架构上提出了一种基于能力调用机制的虚拟机管理器设计方案。

## 1 基于seL4的微内核架构

就嵌入式系统而言，虚拟机管理器主要采用基于微内核的设计模式[3]。一方面，由于嵌入式系统的硬件资源十分有限，如果采用宏内核或部分宏内核设计方式，在系统运行期间，虚拟机管理器部分将占用一定比重的系统资源，如存放内核的存储资源和运行全部虚拟化框架的线程资源等。另一方面，相比于宏内核，微内核的设计在以下几个方面具有突出的优势：隔离性，单点错误不会直接造成连锁反映；可维护性，内核代码量极少，在运行出错时，方便进行断点调试测试；灵活性，由于大部分服务功能部件都位于用户态，所以可采用热插拔的方式向系统中灵活添加所需要的服务功能部件。
通过分析seL4微内核，发现其作为内核组件，只为应用程序提供了少量的服务，如创建和管理进程资源、线程资源，进程间通信机制，创建和管理进程的虚拟地址空间等最基本的服务[4]。对于文件系统、网络与设备的管理等不是内核组件必须具备的功能，则由处于用户态的服务例程来实现。此外 seL4 微内核最显著的特征也是其实现高安全性能的基础，就是为应用程序提供了基于能力机制的访问控制模型。所谓的能力机制类似于Linux中的文件描述符，在Linux系统中一切皆文件，调用Linux系统中的服务，都是通过使用的文件描述符进行的。类似的，seL4中的能力管理着所有的内核对象资源，当用户空间的进程在执行时，首先需要获得其需要使用的内核对象资源所对应的能力值，才能调用这些内核对象资源，进而才能有足够的权限操作内核资源[5]。
因此，基于seL4微内核技术的虚拟机管理器，不仅具备L4架构微内核的所有优势，并且通过seL4特有的能力访问机制，系统既可以实现隔离软件组件的功能，还可以授权特定的通信能力，达成组件间通信可控，真正实现高度安全可靠。
为了实现基于 seL4 微内核架构的嵌入式虚拟化，本文采用了上海交通大学IPADS实验室研发的Chcore微内核作为seL4微内核架构基础。Chcore的架构如图1所示。

![](https://raw.githubusercontent.com/LeroyK111/pictureBed/master/20250213130757.png)

**图1 Chcore 微内核架构图**

通过分析Chcore项目源码，可知该内核类似于seL4微内核，内核部分主要提供进程与线程的创建与管理、进程的调度、进程间通信、内存管理、中断异常管理等功能模块，其余操作系统服务功能模块均在用户态实现。

## 2 基于 Chcore 的嵌入式虚拟化实现
本文研究的嵌入式虚拟机管理器为Chcore Hypervisor，采用了Chcore微内核技术和虚拟化技术相结合的设计方式。为了提高虚拟化管理软件的性能指标，Chcore Hypervisor采用硬件虚拟化加速技术。本研究主要面向嵌入式应用领域，因此采用了ARM架构[6]，ARM架构对虚拟化的支持目前主要有两个版本的标准：ARMv8.0和ARMv8.1。为了最小程度修改Chcore 微内核源码，本研究采用了 ARMv8.0虚拟化架构。将原本的Chcore微内核作为Hypervisor内核态的主要组成部分，其中一部分涉及到具体的逻辑处理，如系统调用与中断处理部分，移植到Hypervisor 的用户态以确保微内核仅提供最核心基础的功能。

### **2.1** **Hypervisor 系统结构**

基于Chcore微内核的虚拟机管理器 Hypervisor系统结构如图2所示。增添的虚拟化功能涉及三个异常级别，其中用户态功能模块实现在 Hypervisor 的EL0层，与底层的内核态功能模块相互配合，以一个虚拟机管理程序的形式向用户提供虚拟机的各种操作接口。内核态功能模块主要在Hypervisor的EL1和EL2层实现，主要用于维持虚拟机的实际运行状态以及向用户态功能模块提供各类操作接口与数据。
![](https://raw.githubusercontent.com/LeroyK111/pictureBed/master/20250213130909.png)


图2中的阴影部分为增添的虚拟化部分，由于采用内核态跨层的设计思路，既充分利用了ARM在虚拟化层提供的功能支持，又可以最小程度地修改微内核。

###  **2.2** **Hypervisor 组件构成**


根据所提出的Hypervisor软件架构，需要设计对应的组件构成。如图3所示，Hypervisor的组件包括：虚拟机管理器，用于创建、配置和管理虚拟机；vCPU调度器，用于调度客户操作系统虚拟机；虚拟内存管理，用于创建管理虚拟内存以及映射和取消映射客户操作系统使用的中间物理地址到物理地址；不同异常级别的虚拟中断异常处理，响应客户操作系统的中断异常陷入，处理外部设备与虚拟机的通信等。

![](https://raw.githubusercontent.com/LeroyK111/pictureBed/master/20250213131011.png)

其中位于EL0、EL1异常级别的虚拟化模块功能相似，这样设计的目的主要是为了遵从Chcore微内核的设计原则，尽可能将代码功能置于用户态以确保微内核仅负责最基础的职责与功能。在设计实现嵌入式虚拟机管理器时，内核态部分仅保留了各类功能所需的基础系统调用，大部分功能（如vCPU的用户态信息管理等）在用户态实现。

###  **3 系统功能测试与性能分析**

本节主要对Hypervisor的功能进行验证测试，以及对添加虚拟化层后的性能影响进行分析。使用的硬件环境为hikey970，拥有4个2.36 GHz的Cortex-A73核和4个1.8 GHz 的Cortex-A53 以及6 GB的LPDDR4和64 GB UFS，外围部分拥有支持4K高清的HDMI 2.0a接口、2个USB3.0接口、2个USB Type-C接口、1个千兆网口，支持CAN V2.0B协议。开发板如图4所示。

![](https://raw.githubusercontent.com/LeroyK111/pictureBed/master/20250213131048.png)
图4 hikey970 开发板


### **3.1** **Hypervisor 功能测试**


当前的hikey970有8个CPU，可实现负载均衡处理。关闭处理器动态均衡调度，在CPU0上同时启动多个虚拟机执行，观察虚拟机内的任务是否正常运行，以此实现系统功能验证。  

通过观察虚拟机启动（见图5）可知，同时启动7个虚拟机，虚拟机内的任务仍然可正常执行，即正常输出task1。打开系统调度日志（见图6)，可发现系统编号为3a3c_3430、3b30、4230、4930、5030、2630、2d30的7个虚拟机正在CPU0上分时复用。

![](https://raw.githubusercontent.com/LeroyK111/pictureBed/master/20250213131141.png)
![](https://raw.githubusercontent.com/LeroyK111/pictureBed/master/20250213131306.png)

### **3.2** **Hypervisor 性能分析**

性能分析方面，主要涉及添加虚拟化层之后，系统IPC、上下文切换、中断处理性能的开销与虚拟机直接运行在hikey970上的开销对比，测试结果如图7和图8所示。 

IPC 性能测试
![](https://raw.githubusercontent.com/LeroyK111/pictureBed/master/20250213131343.png)

上下文切换与中断处理性能测试
![](https://raw.githubusercontent.com/LeroyK111/pictureBed/master/20250213131405.png)
在添加虚拟化层后，对于IPC性能测试，平均每次round- trip IPC通信的cycle数为3302，小于应用标准5000个cycles，因此IPC性能符合要求；对于上下文切换以及中断处理的开销，12000 次上下文切换一共需要2773368 个 cycles, 12000 次中断处理一共需要5279199个 cycles，与直接在 hikey970 上运行12000次进行分析，发现额外开销小于30%，符合应用性能要求。  

综上可知，所实现的Hypervisor 已经可以同时运行多个不同种类的应用执行环境，而且性能可以达到应用需求，证明了基于seL4 微内核架构的嵌入式虚拟化可以满足用户对于嵌入式领域虚拟化的需求。

